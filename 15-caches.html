
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2014-04-16
 Rendered using Maven Reflow Skin 1.0.0 (http://andriusvelykis.github.com/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>Caches | mapdb</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />
 
		<link href="http://netdna.bootstrapcdn.com/bootswatch/2.2.2/spruce/bootstrap.min.css" rel="stylesheet" />
		<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.min.css" rel="stylesheet" />
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/bootswatch.css" rel="stylesheet" />
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/reflow-skin.css" rel="stylesheet" />
		
		<link href="http://yandex.st/highlightjs/7.3/styles/github.min.css" rel="stylesheet" />
		
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/lightbox.css" rel="stylesheet" />
		
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/site.css" rel="stylesheet" />
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/print.css" rel="stylesheet" media="print" />
		
		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		
<style type="text/css">body,h1,h2,h3,h4,h5,h6,code,pre,input,button,select,textarea,.navbar-search,.navbar-search .search-query,h1 small,h2 small,h3 small,h4 small,h5 small,h6 small,.muted,.navbar .brand,.navbar .brand:hover,.navbar .nav li a,.navbar .navbar-text,.navbar .dropdown-menu li a, div.subnav, div.subnav .nav li a,.btn,legend,.alert-heading{
                font-family:Arial, sans-serif;
                }

                @media (max-width:979px){.navbar .nav-collapse .nav li a .navbar .nav-collapse .nav li a:hover, .navbar-inverse .nav-collapse .nav li a:hover, .nav-collapse .navbar-form,.nav-collapse .navbar-search}{
                font-family:Arial, sans-serif;
                }</style>
		<!-- Google Analytics -->
		<script type="text/javascript">
		
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-42074659-1']);
			_gaq.push(['_trackPageview']);

			(function() {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			})();

		</script>
		</head>

	<body class="page-15-caches project-mapdb" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="./"><img src="images/logo.png" border="0" alt="MapDB"/> - java beyond heap</a>
					<div class="nav-collapse">
						<ul class="nav pull-right">
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">MapDB <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="index.html" title="Index">Index </a></li>
									<li><a href="http://www.github.com/jankotek/mapdb" title="Github" class="externalLink">Github </a></li>
									<li><a href="features.html" title="Features">Features </a></li>
									<li><a href="changelog.html" title="Changelog">Changelog </a></li>
									<li><a href="credits.html" title="Credits">Credits </a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">FAQ <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="faq-general.html" title="General">General </a></li>
									<li><a href="faq-problems.html" title="Problems">Problems </a></li>
									<li><a href="faq-performance.html" title="Performance">Performance </a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="02-getting-started.html" title="Getting started">Getting started </a></li>
									<li><a href="http://www.youtube.com/watch?v=FdZmyEHcWLI" title="Overview Video" class="externalLink">Overview Video </a></li>
									<li><a href="https://github.com/jankotek/MapDB/tree/master/src/test/java/examples" title="Examples" class="externalLink">Examples </a></li>
									<li><a href="apidocs/index.html" title="JavaDoc">JavaDoc </a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Support <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="http://groups.google.com/group/mapdb" title="Mail list" class="externalLink">Mail list </a></li>
									<li><a href="https://github.com/jankotek/MapDB/issues" title="Bug tracker" class="externalLink">Bug tracker </a></li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>
		
	<div class="container">
	
	<!-- Masthead
	================================================== -->
		<hr class="toc-separator" />
		<div id="toc-bar" class="navbar">
			<div class="navbar-inner">
				<div id="toc-scroll-target" class="container">
					<ul id="toc" class="nav">
						<li class="toplevel"><a href="#caches" title="Caches">Caches</a></li>
						<li class="toplevel"><a href="#Hash_Table_cache" title="Hash Table cache">Hash Table cache</a></li>
						<li class="toplevel"><a href="#Least-Recently-Used_cache" title="Least-Recently-Used cache">Least-Recently-Used cache</a></li>
						<li class="toplevel"><a href="#Hard_reference_cache" title="Hard reference cache">Hard reference cache</a></li>
						<li class="toplevel"><a href="#Soft_and_Weak_reference_cache" title="Soft and Weak reference cache">Soft and Weak reference cache</a></li>
						<li class="toplevel"><a href="#Disabled_cache_or_reduce_size" title="Disabled cache or reduce size">Disabled cache or reduce size</a></li>
						<li class="toplevel"><a href="#Clear_cache" title="Clear cache">Clear cache</a></li>
						<li class="toplevel"><a href="#Cache_hit_and_miss_statistics" title="Cache hit and miss statistics">Cache hit and miss statistics</a></li>
						<li class="toplevel"><a href="#Cache_priority" title="Cache priority">Cache priority</a></li>
					</ul>
				</div>
			</div>
		</div>
	</header>

	<div class="main-body">
	<div class="row">
		<div class="span12">
			<div class="body-content">
<div class="page-header">
 <h1 id="caches">Caches</h1>
</div> 
<p>MapDB has several options to cache deserialized objects. Proper cache configuration is crucial for good performance of your application. Many performance problems can be fixed just by changing cache settings.</p> 
<p>Most dbs and old generation of MapDB (JDBM) use fixed size to cache read from disk. MapDB eliminated page layer, so it does not have regular cache. Instead it used memory mapped files and relies on operating system to do disk caching.</p> 
<p>When we talk about cache in mapdb we mean <i>instance cache</i> .Instead of pages, MapDB caches deserialized objects such as tree nodes, <tt>Long</tt>, <tt>Person</tt> and so on. Instance cache helps to minimize deserialization overhead. When you fetch an object twice, it will be deserialized only once, second time it will be fetched from cache.</p> 
<p>Because object instance may be stored in cache, yor data-model has to be immutable. On every modification you must create copy of object and persist new version. You also can not modify object fetched from db, an example:</p> 
<div class="source"> 
 <pre>    //wrong
    Person person = new Person();
    map.put(&quot;John&quot;,person);
    person.setName(&quot;John&quot;);

    //right
    Person person = new Person();
    person.setName(&quot;John&quot;);
    map.put(&quot;John&quot;,person);

    //wrong
    Person person = map.get(&quot;John&quot;);
    person.setAge(15);

    //right
    Person person = map.get(&quot;John&quot;);
    person = person.clone();
    person.setAge(15);
    map.put(&quot;John&quot;,person);

</pre> 
</div> 
<p>MapDB offers 5 cache implementations. Some are unbounded and could cause <tt>OutOfMemoryError</tt> when used incorrectly.</p> 
<div class="section"> 
 <h2 id="Hash_Table_cache">Hash Table cache</h2> 
 <p>This cache is fixed size hash table (an array), where elements are placed by recid hash. Old entries are evicted by hash collisions. It has almost zero performance overhead, but provides good results, so this cache is on by default.</p> 
 <p>It does not have automatic entry eviction, so some records may remain in cache (on heap) for very long time. This cache should be used in combination with small records, there is no auto-removal and it could cause <tt>OOME</tt></p> 
 <p>Default cache size is 32000 records, there is DBMaker parameter to regulate its size. This cache is on by default, so it does not need to be enabled in DBMaker. An example:</p> 
 <div class="source"> 
  <pre>    DB db = DBMaker
        .newFileDB(file)          //or memory db
        .cacheSize(1000000)     //optionally change cache size
        .make()

</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Least-Recently-Used_cache">Least-Recently-Used cache</h2> 
 <p>LRU cache keeps track when records are used, and if cache would grow beyond maximal size, it removes least recently used records. Compared to HashTable cache it has better hit statistics, but more overhead. There is overhead associated with maintaining LRU queue. It is recommended to use this cache only if cost of deserialization cost is high and cache miss is serious problem.</p> 
 <p>MRU queue is maintained on ‘best effort’, there are some shortcuts for better performance. So the actual cache size oscillates a few records around maximal size. Please consult <tt>LongConcurrentLRUMap</tt> source for example.</p> 
 <p>This cache is activated by <tt>cacheLRUEnable()</tt> DBMaker parameter. You can also change maximal size, default size is 32000 records. An example:</p> 
 <div class="source"> 
  <pre>    DB db = DBMaker
        .newFileDB(file)        //or memory db
        .cacheLRUEnable()
        .cacheSize(1000000)     //optionally change cache size
        .make()

</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Hard_reference_cache">Hard reference cache</h2> 
 <p>HardRef cache is unbounded cache which does not evict any of its entries. This cahce is practically <tt>Map</tt> of recids and records: <tt>HashMap&lt;recid, Record&gt;</tt></p> 
 <p>If store is larger than heap, it will get filled and eventually cause <tt>OOME</tt> exception. It is great to get great performance from small stores. After cache is warmed, it offers read-only performance comparable to <tt>java.util</tt> collections.</p> 
 <p>MapDB also has weak/soft reference caches, but GC has some serious overhead. So hard reference cache has lower overhead if there is enough memory.</p> 
 <p>This cache is activated with <tt>cacheHardRefEnable()</tt> DBMaker parameter. It does not have maximal size. An example:</p> 
 <div class="source"> 
  <pre>    DB db = DBMaker
        .newFileDB(file)          //or memory db
        .cacheHardRefEnable()
        .make()

</pre> 
 </div> 
 <p>No records are automatically removed from this cache. But you can still clear all records manually:</p> 
 <div class="source"> 
  <pre>    db.getEngine().clearCache();
</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Soft_and_Weak_reference_cache">Soft and Weak reference cache</h2> 
 <p>Other option is to use weak or soft reference cache. In this cache garbage collector removes records from cache. This cache is practically <tt>Map</tt> of recids and references to records: <tt>HashMap&lt;recid, SoftRef&lt;Record&gt;&gt;</tt>.</p> 
 <p>Soft and Weak references differs by eagerness with which they are garbage collected. Weak reference should be GC immediately after all references are released. Soft reference should be only removed when free heap is low. However practical implications depends on JVM settings. For example you can still get <tt>OutOfMemoryError</tt> even with soft references.</p> 
 <p>This caches are activated by <tt>cacheWeakRefEnable()</tt> and <tt>cacheSoftRefEnable()</tt> DBMaker parameters:</p> 
 <div class="source"> 
  <pre>    //weak
    DB db = DBMaker
        .newFileDB(file)            //or memory db
        .cacheWeakRefEnable()
        .make()

    //or soft
    DB db = DBMaker
        .newMemoryDB()              //or file db
        .cacheSoftRefEnable()
        .make()

</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Disabled_cache_or_reduce_size">Disabled cache or reduce size</h2> 
 <p>Instance cache is enabled by default. On small devices you may want to disable it to reduce memory usage. This is done by <tt>cacheDisable()</tt> parameter:</p> 
 <div class="source"> 
  <pre>    DB db = DBMaker
        .newFileDB(file)          //or memory db
        .cacheDisable()
        .make()

</pre> 
 </div> 
 <p>Completely disabling cache hurts performance. So there are could be better alternatives:</p> 
 <p>First you could clear cache after every operation. Checkout howto clearc cache in chapter bellow:</p> 
 <p>Other alternative is to reduce cache size. By default cache size is 32,000 records, probably too much for most Android phones:</p> 
 <div class="source"> 
  <pre>    DB db = DBMaker
        .newFileDB(file)        //or memory db
        .cacheSize(128)         //optionally change cache size
        .make()
</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Clear_cache">Clear cache</h2> 
 <p>If you only use MapDB in batches, you can reduce cache memory overhead, by clearing cache at end of batch:</p> 
 <div class="source"> 
  <pre>    //do some heavy stuff with mapdb:
    map.getAll...

    //we are done clear cache
    db.getEngine().clearCache();

    //now do some other stuff, which does not use MapDB:
    save_my_files...

</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Cache_hit_and_miss_statistics">Cache hit and miss statistics</h2> 
 <p>Right now MapDB does not offer hit/miss statistics for any cache. This feature requires a few lines of code and will be added soon.</p> 
 <p>TODO cache hit/miss statistics.</p> 
</div> 
<div class="section"> 
 <h2 id="Cache_priority">Cache priority</h2> 
 <p>TODO Right now there is no record priority for cache.</p> 
 <p>However it is very easy to add this into MapDB. For example you could give more preferential treatment to btree directory nodes, while leaf nodes would not be cached. All it takes is a few <tt>record instanceof BTreeDirNode</tt> in single class.</p> 
 <p>TODO MapDB could also have flexible multi level cache layering.</p> 
</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->
	
	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="span2 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">MapDB</li>
						<li>
							<a href="index.html" title="Index">Index </a>
						</li>
						<li>
							<a href="http://www.github.com/jankotek/mapdb" title="Github" class="externalLink">Github </a>
						</li>
						<li>
							<a href="features.html" title="Features">Features </a>
						</li>
						<li>
							<a href="changelog.html" title="Changelog">Changelog </a>
						</li>
						<li>
							<a href="credits.html" title="Credits">Credits </a>
						</li>
					</ul>
				</div>
				<div class="span2 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">FAQ</li>
						<li>
							<a href="faq-general.html" title="General">General </a>
						</li>
						<li>
							<a href="faq-problems.html" title="Problems">Problems </a>
						</li>
						<li>
							<a href="faq-performance.html" title="Performance">Performance </a>
						</li>
					</ul>
				</div>
				<div class="span2 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Documentation</li>
						<li>
							<a href="02-getting-started.html" title="Getting started">Getting started </a>
						</li>
						<li>
							<a href="http://www.youtube.com/watch?v=FdZmyEHcWLI" title="Overview Video" class="externalLink">Overview Video </a>
						</li>
						<li>
							<a href="https://github.com/jankotek/MapDB/tree/master/src/test/java/examples" title="Examples" class="externalLink">Examples </a>
						</li>
						<li>
							<a href="apidocs/index.html" title="JavaDoc">JavaDoc </a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Support</li>
						<li>
							<a href="http://groups.google.com/group/mapdb" title="Mail list" class="externalLink">Mail list </a>
						</li>
						<li>
							<a href="https://github.com/jankotek/MapDB/issues" title="Bug tracker" class="externalLink">Bug tracker </a>
						</li>
						<li class="nav-header">Author</li>
						<li>
							<a href="http://www.kotek.net/" title="Blog" class="externalLink">Blog </a>
						</li>
						<li>
							<a href="http://www.twitter.com/jankotek" title="Twitter" class="externalLink">Twitter </a>
						</li>
						<li>
							<a href="mailto:jan@kotek.net" title="Email" class="externalLink">Email </a>
						</li>
						<li>
							<a href="http://www.kotek.net" title="About" class="externalLink">About </a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-description">
					<blockquote><span class="color-highlight">MapDB</span> provides concurrent Maps, Sets and Queues backed by disk storage or off-heap memory.
It is a fast and easy to use embedded Java database engine. And it is completely free under Apache License.
MapDB is free as speech and free as beer under <a href="https://github.com/jankotek/MapDB/blob/master/license.txt">Apache License 2.0</a>.</blockquote>
				</div>
			</div>
		</div>
	</footer>
		
	<div class="container subfooter">
		<div class="row">
			<div class="span12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2014. All Rights Reserved.</p>
				<p class="version-date"><span class="projectVersion">Version: 1.0.0-SNAPSHOT. </span><span class="publishDate">Last Published: 2014-04-16. </span></p>
				<p><a href="http://github.com/andriusvelykis/reflow-maven-skin" title="Reflow Maven skin">Reflow Maven skin</a> by <a href="http://andrius.velykis.lt" target="_blank" title="Andrius Velykis">Andrius Velykis</a>.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->

	<!-- Fallback jQuery loading from Google CDN:
	     http://stackoverflow.com/questions/1014203/best-way-to-use-googles-hosted-jquery-but-fall-back-to-my-hosted-library-on-go -->
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script type="text/javascript">
		if (typeof jQuery == 'undefined')
		{
			document.write(unescape("%3Cscript src='http://andriusvelykis.github.com/reflow-maven-skin//js/jquery-1.8.3.min.js' type='text/javascript'%3E%3C/script%3E"));
		}
	</script>
	
	<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
	<script src="http://andriusvelykis.github.com/reflow-maven-skin//js/lightbox.js"></script>
	<script src="http://andriusvelykis.github.com/reflow-maven-skin//js/jquery.smooth-scroll.min.js"></script>
	<!-- back button support for smooth scroll -->
	<script src="http://andriusvelykis.github.com/reflow-maven-skin//js/jquery.ba-bbq.min.js"></script>
	<script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>

	<script src="http://andriusvelykis.github.com/reflow-maven-skin//js/reflow-skin.js"></script>
	
	</body>
</html>
