
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2014-06-10
 Rendered using Maven Reflow Skin 1.0.0 (http://andriusvelykis.github.com/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>HTreeMap | mapdb</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />
 
		<link href="http://netdna.bootstrapcdn.com/bootswatch/2.2.2/spruce/bootstrap.min.css" rel="stylesheet" />
		<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.min.css" rel="stylesheet" />
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/bootswatch.css" rel="stylesheet" />
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/reflow-skin.css" rel="stylesheet" />
		
		<link href="http://yandex.st/highlightjs/7.3/styles/github.min.css" rel="stylesheet" />
		
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/lightbox.css" rel="stylesheet" />
		
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/site.css" rel="stylesheet" />
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/print.css" rel="stylesheet" media="print" />
		
		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		
<style type="text/css">body,h1,h2,h3,h4,h5,h6,code,pre,input,button,select,textarea,.navbar-search,.navbar-search .search-query,h1 small,h2 small,h3 small,h4 small,h5 small,h6 small,.muted,.navbar .brand,.navbar .brand:hover,.navbar .nav li a,.navbar .navbar-text,.navbar .dropdown-menu li a, div.subnav, div.subnav .nav li a,.btn,legend,.alert-heading{
                font-family:Arial, sans-serif;
                }

                @media (max-width:979px){.navbar .nav-collapse .nav li a .navbar .nav-collapse .nav li a:hover, .navbar-inverse .nav-collapse .nav li a:hover, .nav-collapse .navbar-form,.nav-collapse .navbar-search}{
                font-family:Arial, sans-serif;
                }</style>
		<!-- Google Analytics -->
		<script type="text/javascript">
		
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-42074659-1']);
			_gaq.push(['_trackPageview']);

			(function() {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			})();

		</script>
		</head>

	<body class="page-32-htreemap project-mapdb" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="./"><img src="images/logo.png" border="0" alt="MapDB"/> - java beyond heap</a>
					<div class="nav-collapse">
						<ul class="nav pull-right">
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">MapDB <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="index.html" title="Index">Index </a></li>
									<li><a href="http://www.github.com/jankotek/mapdb" title="Github" class="externalLink">Github </a></li>
									<li><a href="features.html" title="Features">Features </a></li>
									<li><a href="changelog.html" title="Changelog">Changelog </a></li>
									<li><a href="credits.html" title="Credits">Credits </a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">FAQ <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="faq-general.html" title="General">General </a></li>
									<li><a href="faq-problems.html" title="Problems">Problems </a></li>
									<li><a href="faq-performance.html" title="Performance">Performance </a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="02-getting-started.html" title="Getting started">Getting started </a></li>
									<li><a href="http://www.youtube.com/watch?v=FdZmyEHcWLI" title="Overview Video" class="externalLink">Overview Video </a></li>
									<li><a href="https://github.com/jankotek/MapDB/tree/master/src/test/java/examples" title="Examples" class="externalLink">Examples </a></li>
									<li><a href="apidocs/index.html" title="JavaDoc">JavaDoc </a></li>
									<li><a href="doc/cheatsheet.pdf" title="Cheat Sheet">Cheat Sheet </a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Support <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="http://groups.google.com/group/mapdb" title="Mail list" class="externalLink">Mail list </a></li>
									<li><a href="https://github.com/jankotek/MapDB/issues" title="Bug tracker" class="externalLink">Bug tracker </a></li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>
		
	<div class="container">
	
	<!-- Masthead
	================================================== -->
		<hr class="toc-separator" />
		<div id="toc-bar" class="navbar">
			<div class="navbar-inner">
				<div id="toc-scroll-target" class="container">
					<ul id="toc" class="nav">
						<li class="toplevel"><a href="#htreemap" title="HTreeMap">HTreeMap</a></li>
						<li class="toplevel"><a href="#Parameters" title="Parameters">Parameters</a></li>
						<li class="toplevel"><a href="#Entry_expiration_parameters" title="Entry expiration parameters">Entry expiration parameters</a></li>
						<li class="toplevel"><a href="#Compared_to_BTreeMap" title="Compared to BTreeMap">Compared to BTreeMap</a></li>
					</ul>
				</div>
			</div>
		</div>
	</header>

	<div class="main-body">
	<div class="row">
		<div class="span12">
			<div class="body-content">
<div class="page-header">
 <h1 id="htreemap">HTreeMap</h1>
</div> 
<p>HTreeMap (aka HashMap) is one of <tt>Map</tt>s offered by MapDB. It has great performance with large keys. It also offers entry expiration if time-to-live or maximal size is exceeded.</p> 
<p>HTreeMap is <i>segmented Hash Tree</i>. Most hash collections use an array for hash table, which requires copying all data when hash table is resized. HTreeMap uses auto-expanding 4 level tree, so it never needs resizing.</p> 
<p>To support concurrency HTreeMap is split to 16 independent segments, each with separate read-write lock. <tt>ConcurrentHashMap</tt> works similar way. Number of segments (also called concurrency factor) is hard wired into design and can not be changed.</p> 
<p>HTreeMap optionally supports entry expiration based on four criteria: maximal map size, time-to-live since last modification and time-to-live since last access. Expired entries are automatically removed. This feature uses FIFO queue, each segment has independent expiration queue. Priority per entry can not be set.</p> 
<div class="section"> 
 <h2 id="Parameters">Parameters</h2> 
 <p>HTreeMap has number of parameters to tune its performance. Number of segments (aka concurrency factor) is hard-coded to16 and can not be changed. Other params can be set only when map is created and can not be changed latter.</p> 
 <p>Most important are probably <b>serializers</b>. General serialization has some guessing and overhead, so it always has better performance to use more specific serializers. To specify key and value serializer use code bellow. There are dozens ready to use serializers available as static fields on <tt>Serializer</tt> interface:</p> 
 <div class="source"> 
  <pre>    HTreeMap&lt;String, Long&gt; map = db.createHashMap(&quot;map&quot;)
        .keySerializer(Serializer.STRING)
        .valueSerializer(Serializer.LONG)
        .makeOrGet()
</pre> 
 </div> 
 <p>HTreeMap is recommended for handling large key/values. In same cases you may want to use compression. Enabling compression store-wide is not always best, since constantly (de)compressing index tree has overhead. Instead it is better to apply compression just to specific large key. This is done by using serializer wrapper:</p> 
 <div class="source"> 
  <pre>    HTreeMap&lt;String, Long&gt; map = db.createHashMap(&quot;map&quot;)
        .keySerializer(new Serializer.CompressionWrapper(Serializer.STRING))
        .makeOrGet()
</pre> 
 </div> 
 <p>Other useful parameter is <b>Hasher</b>. By default HTreeMap uses 32bit hash generated by <tt>hashCode()</tt>. Some classes just return memory pointer, which changes after serialization/deserialization, rendering it useless for persistence. Also it is not always necessary to calculate full hash of large objects (Strings), sometimes it is better to use weaker hash. So HTreeMap allows you to supply custom Hasher which will generate hash code for keys and decide which keys are equal. This way you can use primitive arrays as key without wrapper:</p> 
 <div class="source"> 
  <pre>    HTreeMap&lt;byte[], Long&gt; map = db.createHashMap(&quot;map&quot;)
        .keySerializer(Serializer.BYTE_ARRAY)
        .hasher(Hasher.BYTE_ARRAY)
        .makeOrGet()
</pre> 
 </div> 
 <p>Other parameter is <b>size counter</b>. By default HTreeMap does not keep track of its size, calling <tt>map.size()</tt> requires linear scan to count all entries. You can change it by enabling size counter, in that case <tt>map.size()</tt> is instant, but there is some overhead on inserts.</p> 
 <div class="source"> 
  <pre>    HTreeMap&lt;String, Long&gt; map = db.createHashMap(&quot;map&quot;)
        .counterEnable()
        .makeOrGet()
</pre> 
 </div> 
 <p>And finally some sugar. There is <b>value creator</b>, a function to create value if existing value is not found. Newly created value is inserted into map. This way <tt>map.get(key)</tt> never returns null. This is mainly useful for various generators and caches.</p> 
 <div class="source"> 
  <pre>    HTreeMap&lt;String,Long&gt; map = db.createHashMap(&quot;map&quot;)
            .valueCreator(new Fun.Function1&lt;Long,String&gt;() {
                @Override public Long run(String o) {
                    return 1111L;
                }
            })
            .makeOrGet();
</pre> 
 </div> 
 <p>or more readable version in Java 8:</p> 
 <div class="source"> 
  <pre>    HTreeMap&lt;String,Long&gt; map = db.createHashMap(&quot;map&quot;)
            .valueCreator((key)-&gt; 1111L)
            .makeOrGet();

    // this way map.get() returns 1111L if no value is found
    map.get(&quot;aa&quot;); // 1111L
    map.get(&quot;bb&quot;); // 1111L

    // map now contains [&quot;aa&quot;-&gt;1111L, &quot;bb&quot;-&gt;1111L]
</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Entry_expiration_parameters">Entry expiration parameters</h2> 
 <p><tt>HTreeMap</tt> offers optional entry expiration if some conditions are met. Entry can expire if:</p> 
 <ul> 
  <li> <p>Number of entries in map would exceed maximal size</p></li> 
  <li> <p>Entry exist in map longer time than expiration period is. The expiration period could be since last modification or last read access.</p></li> 
  <li> <p>Disk/memory space consumed by Map is bigger then some limit in GB.</p></li> 
 </ul> 
 <p>There is shortcut in <tt>DBMaker</tt> to quickly use <tt>HTreeMap</tt> as off-heap cache with memory size limit:</p> 
 <div class="source"> 
  <pre>    // Off-heap map with max size 16GB
    Map cache = DBMaker
	    .newCacheDirect(16)
</pre> 
 </div> 
 <p>This equals to <tt>expireStoreSize</tt> param:</p> 
 <div class="source"> 
  <pre>    HTreeMap cache = db.createHashMap(&quot;cache&quot;)
        .expireStoreSize(128)
        .makeOrGet()
</pre> 
 </div> 
 <p>It is also possible to limit maximal size of map:</p> 
 <div class="source"> 
  <pre>    HTreeMap cache = db.createHashMap(&quot;cache&quot;)
        .expireMaxSize(128)
        .makeOrGet()
</pre> 
 </div> 
 <p>And finally you can set expiration time since last modification or since last access.</p> 
 <div class="source"> 
  <pre>    // remove all entries 1H after last modification, or 10 minutes after last get()
    HTreeMap cache = db.createHashMap(&quot;cache&quot;)
         .expireAfterWrite(1, TimeUnit.HOURS)
         .expireAfterRead(10, TimeUnit.MINUTES)
         .makeOrGet()
</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Compared_to_BTreeMap">Compared to BTreeMap</h2> 
 <p>HTreeMap has one major advantage for using with large keys. Unlike BTreeMap it only stores hash codes in tree nodes. Each lookup on BTreeMap deserializes number of tree nodes together with their keys.</p> 
 <p>TODO link to performance test, compare with BTreeMap</p> 
 <p>On other side HTreeMap has limited concurrency factor to 16, so its writes wont scale over 4 CPU cores. It uses read-write locks, so read operations are not affected. However in practice disk IO is more likely to be bottleneck.</p> 
</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->
	
	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="span2 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">MapDB</li>
						<li>
							<a href="index.html" title="Index">Index </a>
						</li>
						<li>
							<a href="http://www.github.com/jankotek/mapdb" title="Github" class="externalLink">Github </a>
						</li>
						<li>
							<a href="features.html" title="Features">Features </a>
						</li>
						<li>
							<a href="changelog.html" title="Changelog">Changelog </a>
						</li>
						<li>
							<a href="credits.html" title="Credits">Credits </a>
						</li>
					</ul>
				</div>
				<div class="span2 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">FAQ</li>
						<li>
							<a href="faq-general.html" title="General">General </a>
						</li>
						<li>
							<a href="faq-problems.html" title="Problems">Problems </a>
						</li>
						<li>
							<a href="faq-performance.html" title="Performance">Performance </a>
						</li>
					</ul>
				</div>
				<div class="span2 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Documentation</li>
						<li>
							<a href="02-getting-started.html" title="Getting started">Getting started </a>
						</li>
						<li>
							<a href="http://www.youtube.com/watch?v=FdZmyEHcWLI" title="Overview Video" class="externalLink">Overview Video </a>
						</li>
						<li>
							<a href="https://github.com/jankotek/MapDB/tree/master/src/test/java/examples" title="Examples" class="externalLink">Examples </a>
						</li>
						<li>
							<a href="apidocs/index.html" title="JavaDoc">JavaDoc </a>
						</li>
						<li>
							<a href="doc/cheatsheet.pdf" title="Cheat Sheet">Cheat Sheet </a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Support</li>
						<li>
							<a href="http://groups.google.com/group/mapdb" title="Mail list" class="externalLink">Mail list </a>
						</li>
						<li>
							<a href="https://github.com/jankotek/MapDB/issues" title="Bug tracker" class="externalLink">Bug tracker </a>
						</li>
						<li class="nav-header">Author</li>
						<li>
							<a href="http://www.kotek.net/" title="Blog" class="externalLink">Blog </a>
						</li>
						<li>
							<a href="http://www.twitter.com/jankotek" title="Twitter" class="externalLink">Twitter </a>
						</li>
						<li>
							<a href="mailto:jan@kotek.net" title="Email" class="externalLink">Email </a>
						</li>
						<li>
							<a href="http://www.kotek.net" title="About" class="externalLink">About </a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-description">
					<blockquote><span class="color-highlight">MapDB</span> provides concurrent Maps, Sets and Queues backed by disk storage or off-heap memory.
It is a fast and easy to use embedded Java database engine. And it is completely free under Apache License.
MapDB is free as speech and free as beer under <a href="https://github.com/jankotek/MapDB/blob/master/license.txt">Apache License 2.0</a>.</blockquote>
				</div>
			</div>
		</div>
	</footer>
		
	<div class="container subfooter">
		<div class="row">
			<div class="span12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2014. All Rights Reserved.</p>
				<p class="version-date"><span class="projectVersion">Version: 1.1.0-SNAPSHOT. </span><span class="publishDate">Last Published: 2014-06-10. </span></p>
				<p><a href="http://github.com/andriusvelykis/reflow-maven-skin" title="Reflow Maven skin">Reflow Maven skin</a> by <a href="http://andrius.velykis.lt" target="_blank" title="Andrius Velykis">Andrius Velykis</a>.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->

	<!-- Fallback jQuery loading from Google CDN:
	     http://stackoverflow.com/questions/1014203/best-way-to-use-googles-hosted-jquery-but-fall-back-to-my-hosted-library-on-go -->
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script type="text/javascript">
		if (typeof jQuery == 'undefined')
		{
			document.write(unescape("%3Cscript src='http://andriusvelykis.github.com/reflow-maven-skin//js/jquery-1.8.3.min.js' type='text/javascript'%3E%3C/script%3E"));
		}
	</script>
	
	<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
	<script src="http://andriusvelykis.github.com/reflow-maven-skin//js/lightbox.js"></script>
	<script src="http://andriusvelykis.github.com/reflow-maven-skin//js/jquery.smooth-scroll.min.js"></script>
	<!-- back button support for smooth scroll -->
	<script src="http://andriusvelykis.github.com/reflow-maven-skin//js/jquery.ba-bbq.min.js"></script>
	<script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>

	<script src="http://andriusvelykis.github.com/reflow-maven-skin//js/reflow-skin.js"></script>
	
	</body>
</html>
